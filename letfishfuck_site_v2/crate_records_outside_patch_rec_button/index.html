<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRATE RECORDS OUTSIDE</title>
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CRATE RECORDS">

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23000000'/><circle cx='50' cy='50' r='35' fill='%2300ff88' stroke='%23ffffff' stroke-width='3'/><path d='M50,20 L50,80 M20,50 L80,50' stroke='%23000000' stroke-width='4'/></svg>">

  <!-- Fonts -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
  </style>

  <!-- Styles -->
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --bg-dark:#0a0a0a;
      --panel-dark:#1a1a1a;
      --panel-dark-secondary:#222222;
      --text-dark:#ffffff;
      --accent-dark:#00ff88;
      --accent-dark-secondary:#00ccaa;
      --knob-dark:#333333;
      --knob-dark-highlight:#444444;

      --bg-light:#f5f5f5;
      --panel-light:#ffffff;
      --panel-light-secondary:#e8e8e8;
      --text-light:#222222;
      --accent-light:#008855;
      --accent-light-secondary:#006699;
      --knob-light:#dddddd;
      --knob-light-highlight:#eeeeee;

      --danger:#ff3333;
      --warning:#ffaa00;
      --success:#00cc66;
    }

    body.dark-mode {
      --bg:var(--bg-dark);
      --panel:var(--panel-dark);
      --panel-secondary:var(--panel-dark-secondary);
      --text:var(--text-dark);
      --accent:var(--accent-dark);
      --accent-secondary:var(--accent-dark-secondary);
      --knob:var(--knob-dark);
      --knob-highlight:var(--knob-dark-highlight);
    }

    body.light-mode {
      --bg:var(--bg-light);
      --panel:var(--panel-light);
      --panel-secondary:var(--panel-light-secondary);
      --text:var(--text-light);
      --accent:var(--accent-light);
      --accent-secondary:var(--accent-light-secondary);
      --knob:var(--knob-light);
      --knob-highlight:var(--knob-light-highlight);
    }

    body{
      font-family:'Share Tech Mono', monospace;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:20px;
      transition:all .3s ease;
      position:relative;
      overflow-x:hidden;
    }

    body::before{
      content:'';
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at 20% 80%, rgba(0,255,136,.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0,204,170,.1) 0%, transparent 50%);
      z-index:-1;
    }

    .offline-indicator{
      position:fixed;
      top:10px;
      right:10px;
      background:var(--warning);
      color:var(--panel);
      padding:5px 15px;
      border-radius:20px;
      font-size:12px;
      display:none;
      z-index:1000;
    }
    body.offline .offline-indicator{ display:block; }

    .app-header{ width:100%; max-width:900px; margin-bottom:25px; }
    .title-bar{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid var(--accent);
    }
    .app-title{
      font-family:'Orbitron',sans-serif; font-size:28px; font-weight:900;
      letter-spacing:3px; color:var(--accent); text-transform:uppercase;
      text-shadow:0 0 10px rgba(0,255,136,.3);
    }
    .theme-toggle{
      background:transparent; border:2px solid var(--accent); color:var(--accent);
      padding:8px 20px; border-radius:20px; cursor:pointer;
      font-family:'Share Tech Mono', monospace; font-size:12px;
      transition:all .3s; letter-spacing:1px;
    }
    .theme-toggle:hover{ background:var(--accent); color:var(--panel); transform:translateY(-2px); }
    .tagline{ text-align:center; font-size:14px; color:var(--accent-secondary); margin-top:5px; letter-spacing:2px; }

    .studio-rack{
      width:100%; max-width:900px;
      background:var(--panel);
      border-radius:15px;
      padding:30px;
      border:3px solid var(--accent);
      box-shadow:0 20px 40px rgba(0,0,0,.4), inset 0 1px 3px rgba(255,255,255,.1);
      position:relative;
      overflow:hidden;
    }
    .studio-rack::before{
      content:''; position:absolute; top:0; left:0; right:0; height:5px;
      background:linear-gradient(90deg, var(--accent) 0%, var(--accent-secondary) 50%, var(--accent) 100%);
    }

    .vu-section{
      background:var(--panel-secondary);
      border-radius:10px;
      padding:20px;
      margin-bottom:30px;
      border:2px solid var(--accent-secondary);
    }
    .vu-meter{
      width:100%; height:120px;
      background:linear-gradient(90deg,#001100 0%,#003300 20%,#006600 40%,#009900 60%,#00cc00 70%,#ffff00 80%,#ff9900 90%,#ff3300 95%,#990000 100%);
      border-radius:8px;
      position:relative;
      overflow:hidden;
      border:2px solid var(--accent);
      margin-bottom:10px;
    }
    .vu-level{ position:absolute; top:0; left:0; height:100%; width:0%; background:rgba(255,255,255,.2); transition:width .05s ease-out; }
    .vu-grid{
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:repeating-linear-gradient(to right, transparent, transparent 9.5%, rgba(255,255,255,.1) 9.5%, rgba(255,255,255,.1) 10%);
    }
    .vu-labels{ display:flex; justify-content:space-between; font-size:12px; color:var(--accent); margin-top:5px; }

    .source-selector{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:15px;
      margin-bottom:30px;
    }
    .source-btn{
      padding:15px;
      background:var(--panel-secondary);
      border:2px solid var(--accent-secondary);
      border-radius:8px;
      color:var(--text);
      cursor:pointer;
      text-align:center;
      transition:all .3s;
      font-family:'Share Tech Mono', monospace;
      font-size:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .source-btn.active{
      background:var(--accent);
      color:var(--panel);
      border-color:var(--accent);
      box-shadow:0 0 20px rgba(0,255,136,.3);
    }
    .source-btn:hover:not(.active){ border-color:var(--accent); transform:translateY(-2px); }
    .source-icon{ font-size:24px; }
    .source-desc{ font-size:12px; opacity:.8; }

    .knobs-section{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:20px;
      margin-bottom:30px;
    }
    .knob-group{
      background:var(--panel-secondary);
      border-radius:10px;
      padding:20px;
      border:2px solid var(--accent-secondary);
    }
    .knob-group-title{
      font-size:14px;
      color:var(--accent);
      margin-bottom:15px;
      text-align:center;
      text-transform:uppercase;
      letter-spacing:2px;
    }
    .knob-container{ text-align:center; margin-bottom:15px; }
    .knob-label{ font-size:12px; margin-bottom:10px; color:var(--text); text-transform:uppercase; letter-spacing:1px; }
    .knob{ width:80px; height:80px; margin:0 auto; position:relative; cursor:pointer; }
    .knob-base{
      width:100%; height:100%;
      background:radial-gradient(circle at 30% 30%, var(--knob-highlight), var(--knob));
      border-radius:50%;
      position:relative;
      box-shadow:inset 0 0 20px rgba(0,0,0,.5), 0 10px 20px rgba(0,0,0,.3);
      border:2px solid var(--accent-secondary);
    }
    .knob-marker{
      position:absolute;
      top:10px; left:50%;
      width:4px; height:25px;
      background:var(--accent);
      transform-origin:bottom center;
      transform:translateX(-50%) rotate(0deg);
      transition:transform .1s;
      border-radius:2px;
    }
    .knob-value{ font-size:12px; color:var(--accent); margin-top:10px; font-weight:bold; }

    .transport-section{
      display:flex;
      justify-content:center;
      gap:30px;
      margin-bottom:30px;
      flex-wrap:wrap;
      scroll-margin-top: 20px;
    }
    .transport-btn{
      width:90px; height:90px;
      border-radius:50%;
      border:none;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-family:'Orbitron',sans-serif;
      font-size:14px;
      font-weight:bold;
      text-transform:uppercase;
      letter-spacing:2px;
      transition:all .3s;
      position:relative;
      overflow:hidden;
    }
    .transport-btn:disabled{ opacity:.5; cursor:not-allowed; transform:none !important; }
    .transport-btn:not(:disabled):hover{ transform:scale(1.1); }
    .transport-btn:not(:disabled):active{ transform:scale(.95); }
    .btn-record{ background:radial-gradient(circle at 30% 30%, #ff5555, #cc0000); color:#fff; border:4px solid #ff7777; box-shadow:0 10px 30px rgba(255,0,0,.3); }
    .btn-record.recording{ background:radial-gradient(circle at 30% 30%, #ff0000, #990000); box-shadow:0 0 30px rgba(255,0,0,.7); animation:pulse-red 1s infinite; }
    .btn-stop{ background:radial-gradient(circle at 30% 30%, var(--warning), #cc8800); color:#fff; border:4px solid #ffcc00; box-shadow:0 10px 30px rgba(255,170,0,.3); }
    .btn-save{ background:radial-gradient(circle at 30% 30%, var(--success), #00aa55); color:#fff; border:4px solid #00ff88; box-shadow:0 10px 30px rgba(0,255,136,.3); }
    .btn-icon{ font-size:28px; margin-bottom:5px; }

    .status-section{
      background:var(--panel-secondary);
      border-radius:10px;
      padding:20px;
      margin-bottom:20px;
      border:2px solid var(--accent);
      position:relative;
    }
    .timer{
      font-family:'Orbitron',sans-serif;
      font-size:32px;
      text-align:center;
      color:var(--accent);
      margin-bottom:10px;
      text-shadow:0 0 10px rgba(0,255,136,.3);
      letter-spacing:3px;
    }
    .status-text{
      font-size:14px;
      text-align:center;
      color:var(--text);
      min-height:20px;
      padding:10px;
      background:rgba(0,0,0,.2);
      border-radius:5px;
      border:1px solid var(--accent-secondary);
    }
    .status-text.recording{
      color:var(--accent);
      border-color:var(--accent);
      background:rgba(0,255,136,.1);
    }

    .install-btn{
      display:block;
      width:100%;
      margin-top:20px;
      padding:15px;
      background:var(--accent);
      color:var(--panel);
      border:none;
      border-radius:8px;
      font-family:'Orbitron',sans-serif;
      font-size:16px;
      font-weight:bold;
      text-transform:uppercase;
      letter-spacing:2px;
      cursor:pointer;
      transition:all .3s;
    }
    .install-btn:hover{ background:var(--accent-secondary); transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,255,136,.3); }
    .hidden{ display:none; }

    @keyframes pulse-red{
      0%,100%{ box-shadow:0 0 30px rgba(255,0,0,.7); }
      50%{ box-shadow:0 0 50px rgba(255,0,0,.9); }
    }
    .recording-indicator{
      display:inline-block;
      width:12px; height:12px;
      border-radius:50%;
      background:var(--danger);
      animation:pulse-red 1s infinite;
      margin-right:8px;
    }

    /* ---- REC micro button (requested) ---- */
    .rec-fab{
      position:fixed;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      padding:8px 14px;
      border-radius:999px;
      border:2px solid var(--accent);
      background:rgba(0,0,0,.25);
      color:var(--accent);
      font-family:'Orbitron',sans-serif;
      font-size:12px;
      letter-spacing:2px;
      text-transform:uppercase;
      cursor:pointer;
      z-index:1100;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .rec-fab:hover{ background:var(--accent); color:var(--panel); }
    .rec-fab:active{ transform:translateX(-50%) scale(.98); }

    @media (max-width:768px){
      .studio-rack{ padding:20px; }
      .source-selector{ grid-template-columns:1fr; }
      .knobs-section{ grid-template-columns:1fr; }
      .transport-section{ gap:15px; }
      .transport-btn{ width:70px; height:70px; font-size:12px; }
      .timer{ font-size:24px; }
    }
  </style>
</head>
<body class="dark-mode">
  <div class="offline-indicator">OFFLINE MODE</div>

  <div class="app-header">
    <div class="title-bar">
      <h1 class="app-title">CRATE RECORDS OUTSIDE</h1>
      <button class="theme-toggle" id="themeToggle">LIGHT MODE</button>
    </div>
    <div class="tagline">SYSTEM AUDIO CAPTURE STUDIO</div>
  </div>

  <div class="studio-rack">
    <div class="vu-section">
      <div class="vu-meter">
        <div class="vu-grid"></div>
        <div class="vu-level" id="vuLevel"></div>
      </div>
      <div class="vu-labels">
        <span>-INF</span><span>-20dB</span><span>-10dB</span><span>0dB</span><span>+3dB</span><span>+6dB</span>
      </div>
    </div>

    <div class="source-selector">
      <button class="source-btn" id="systemAudioBtn">
        <div class="source-icon">üíª</div>
        <div><div>SYSTEM AUDIO</div><div class="source-desc">Capture from DAW/Apps (Desktop)</div></div>
      </button>

      <button class="source-btn active" id="tabAudioBtn">
        <div class="source-icon">üì∫</div>
        <div><div>TAB AUDIO</div><div class="source-desc">Capture Chrome Tab Audio</div></div>
      </button>

      <button class="source-btn" id="micAudioBtn">
        <div class="source-icon">üé§</div>
        <div><div>MICROPHONE</div><div class="source-desc">Standard Microphone</div></div>
      </button>
    </div>

    <div class="knobs-section">
      <div class="knob-group">
        <div class="knob-group-title">EQUALIZER</div>
        <div class="knob-container">
          <div class="knob-label">LOW</div>
          <div class="knob" data-knob="bass"><div class="knob-base"><div class="knob-marker" id="bassMarker"></div></div></div>
          <div class="knob-value" id="bassValue">0 dB</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">MID</div>
          <div class="knob" data-knob="mid"><div class="knob-base"><div class="knob-marker" id="midMarker"></div></div></div>
          <div class="knob-value" id="midValue">0 dB</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">HIGH</div>
          <div class="knob" data-knob="treble"><div class="knob-base"><div class="knob-marker" id="trebleMarker"></div></div></div>
          <div class="knob-value" id="trebleValue">0 dB</div>
        </div>
      </div>

      <div class="knob-group">
        <div class="knob-group-title">EFFECTS</div>
        <div class="knob-container">
          <div class="knob-label">REVERB</div>
          <div class="knob" data-knob="reverb"><div class="knob-base"><div class="knob-marker" id="reverbMarker"></div></div></div>
          <div class="knob-value" id="reverbValue">0%</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">DELAY</div>
          <div class="knob" data-knob="delay"><div class="knob-base"><div class="knob-marker" id="delayMarker"></div></div></div>
          <div class="knob-value" id="delayValue">0%</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">SATURATION</div>
          <div class="knob" data-knob="saturation"><div class="knob-base"><div class="knob-marker" id="saturationMarker"></div></div></div>
          <div class="knob-value" id="saturationValue">0%</div>
        </div>
      </div>
    </div>

    <div class="transport-section" id="transport">
      <button class="transport-btn btn-record" id="recordBtn">
        <div class="btn-icon">‚óè</div><span>REC</span>
      </button>
      <button class="transport-btn btn-stop" id="stopBtn" disabled>
        <div class="btn-icon">‚ñ†</div><span>STOP</span>
      </button>
      <button class="transport-btn btn-save" id="saveBtn" disabled>
        <div class="btn-icon">‚Üì</div><span>SAVE</span>
      </button>
    </div>

    <div class="status-section">
      <div class="timer" id="timer">00:00:00</div>
      <div class="status-text" id="statusText">Ready to record. Select audio source above.</div>
    </div>

    <button class="install-btn hidden" id="installBtn">‚¨á INSTALL AS STUDIO APP</button>
  </div>

  <!-- Fixed micro REC button (bottom) -->
  <button class="rec-fab" id="recFab" title="Jump to REC / start recording">REC</button>

  <script>
    // Service Worker (inline)
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'crate-records-studio-v2';
        const urlsToCache = ['/'];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request).then(response => response || fetch(event.request))
          );
        });

        self.addEventListener('activate', event => {
          event.waitUntil(
            caches.keys().then(cacheNames => Promise.all(
              cacheNames.map(cacheName => cacheName !== CACHE_NAME ? caches.delete(cacheName) : null)
            ))
          );
        });
      `;
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }

    class CrateRecordsStudio {
      constructor(){
        this.isRecording=false;
        this.recordingStart=null;
        this.timerInterval=null;
        this.audioChunks=[];
        this.mediaRecorder=null;
        this.audioContext=null;
        this.sourceNode=null;
        this.analyser=null;
        this.destination=null;
        this.audioStream=null;
        this.recordingMode='tab';
        this.recordingBlob=null;

        this.knobValues={ bass:0, mid:0, treble:0, reverb:0, delay:0, saturation:0 };

        this.themeToggle=document.getElementById('themeToggle');
        this.recordBtn=document.getElementById('recordBtn');
        this.stopBtn=document.getElementById('stopBtn');
        this.saveBtn=document.getElementById('saveBtn');
        this.timerDisplay=document.getElementById('timer');
        this.statusText=document.getElementById('statusText');
        this.vuLevel=document.getElementById('vuLevel');
        this.installBtn=document.getElementById('installBtn');
        this.recFab=document.getElementById('recFab');

        this.systemAudioBtn=document.getElementById('systemAudioBtn');
        this.tabAudioBtn=document.getElementById('tabAudioBtn');
        this.micAudioBtn=document.getElementById('micAudioBtn');

        this.deferredPrompt=null;

        this.init();
      }

      async init(){
        this.setupEventListeners();
        this.setupKnobs();
        this.setupInstallPrompt();
        await this.initializeAudio('tab');
        this.updateStatus('Ready to record. Select audio source above.');
      }

      setupEventListeners(){
        this.themeToggle.addEventListener('click', () => {
          if (document.body.classList.contains('dark-mode')) {
            document.body.classList.remove('dark-mode');
            document.body.classList.add('light-mode');
            this.themeToggle.textContent='DARK MODE';
          } else {
            document.body.classList.remove('light-mode');
            document.body.classList.add('dark-mode');
            this.themeToggle.textContent='LIGHT MODE';
          }
        });

        this.systemAudioBtn.addEventListener('click', () => this.setRecordingMode('system'));
        this.tabAudioBtn.addEventListener('click', () => this.setRecordingMode('tab'));
        this.micAudioBtn.addEventListener('click', () => this.setRecordingMode('mic'));

        this.recordBtn.addEventListener('click', () => this.startRecording());
        this.stopBtn.addEventListener('click', () => this.stopRecording());
        this.saveBtn.addEventListener('click', () => this.downloadRecording());

        // Micro REC button: jump + "try start"
        this.recFab.addEventListener('click', async () => {
          document.getElementById('transport')?.scrollIntoView({behavior:'smooth', block:'center'});
          // If not recording, attempt to start (will fail gracefully if permissions missing)
          if (!this.isRecording && !this.recordBtn.disabled) {
            await this.startRecording();
          }
        });

        window.addEventListener('online', () => { document.body.classList.remove('offline'); this.updateStatus('Back online'); });
        window.addEventListener('offline', () => { document.body.classList.add('offline'); this.updateStatus('Offline - recording still works'); });
      }

      setupKnobs(){
        const knobs=document.querySelectorAll('.knob');
        knobs.forEach(knob=>{
          const knobName=knob.dataset.knob;
          let isDragging=false;
          let startAngle=0;
          let currentValue=this.knobValues[knobName]||0;

          const updateKnob=(value)=>{
            this.knobValues[knobName]=Math.round(value);
            const marker=document.getElementById(`${knobName}Marker`);
            const valueDisplay=document.getElementById(`${knobName}Value`);
            if (!marker || !valueDisplay) return;

            let rotation=0;
            let displayValue='';

            if (['bass','mid','treble'].includes(knobName)){
              rotation=value*1.8;
              displayValue=`${value>0?'+':''}${Math.round(value)} dB`;
            } else {
              rotation=value*3.6;
              displayValue=`${Math.round(value)}%`;
            }

            marker.style.transform=`translateX(-50%) rotate(${rotation}deg)`;
            valueDisplay.textContent=displayValue;

            this.updateAudioEffects();
          };

          const begin=(clientX, clientY)=>{
            isDragging=true;
            const rect=knob.getBoundingClientRect();
            const cx=rect.left+rect.width/2;
            const cy=rect.top+rect.height/2;
            startAngle=Math.atan2(clientY-cy, clientX-cx)*180/Math.PI;
          };

          const move=(clientX, clientY)=>{
            if(!isDragging) return;
            const rect=knob.getBoundingClientRect();
            const cx=rect.left+rect.width/2;
            const cy=rect.top+rect.height/2;
            const currentAngle=Math.atan2(clientY-cy, clientX-cx)*180/Math.PI;
            let angleDiff=currentAngle-startAngle;

            if (['bass','mid','treble'].includes(knobName)){
              currentValue=Math.max(-50, Math.min(50, currentValue+angleDiff));
            } else {
              currentValue=Math.max(0, Math.min(100, currentValue+angleDiff*2));
            }

            updateKnob(currentValue);
            startAngle=currentAngle;
          };

          const end=()=>{ isDragging=false; };

          knob.addEventListener('mousedown', (e)=>{ begin(e.clientX, e.clientY); document.body.style.cursor='grabbing'; e.preventDefault(); });
          document.addEventListener('mousemove', (e)=> move(e.clientX, e.clientY));
          document.addEventListener('mouseup', ()=>{ end(); document.body.style.cursor=''; });

          knob.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; begin(t.clientX, t.clientY); e.preventDefault(); }, {passive:false});
          document.addEventListener('touchmove', (e)=>{ const t=e.touches[0]; if(t) move(t.clientX, t.clientY); }, {passive:false});
          document.addEventListener('touchend', ()=> end());

          updateKnob(currentValue);
        });
      }

      setupInstallPrompt(){
        window.addEventListener('beforeinstallprompt', (e)=>{
          e.preventDefault();
          this.deferredPrompt=e;
          this.installBtn.classList.remove('hidden');
        });
        this.installBtn.addEventListener('click', ()=> this.installApp());
      }

      async setRecordingMode(mode){
        this.recordingMode=mode;
        [this.systemAudioBtn, this.tabAudioBtn, this.micAudioBtn].forEach(b=>b.classList.remove('active'));
        if (mode==='system') this.systemAudioBtn.classList.add('active');
        if (mode==='tab') this.tabAudioBtn.classList.add('active');
        if (mode==='mic') this.micAudioBtn.classList.add('active');

        if (this.isRecording) this.stopRecording();
        await this.initializeAudio(mode);
      }

      async initializeAudio(mode){
        try{
          if (this.audioStream) this.audioStream.getTracks().forEach(t=>t.stop());
          let stream=null;

          if (mode==='mic'){
            stream=await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:false, noiseSuppression:false, autoGainControl:false, sampleRate:44100, channelCount:2 }});
            this.updateStatus('Microphone ready - Speak to test');
          } else if (mode==='tab'){
            const displayStream=await navigator.mediaDevices.getDisplayMedia({
              video:{ displaySurface:'browser', width:{ideal:1280}, height:{ideal:720} },
              audio:{ echoCancellation:false, noiseSuppression:false, autoGainControl:false, sampleRate:44100 },
              systemAudio:'include',
              surfaceSwitching:'include'
            });
            stream=new MediaStream(displayStream.getAudioTracks());
            this.updateStatus('Tab audio ready - Play audio in any tab to record');
          } else { // system
            const displayStream=await navigator.mediaDevices.getDisplayMedia({
              video:true,
              audio:{ echoCancellation:false, noiseSuppression:false, autoGainControl:false, sampleRate:44100 },
              systemAudio:'include'
            });
            stream=new MediaStream(displayStream.getAudioTracks());
            this.updateStatus('System audio ready - Record from any app');
          }

          this.audioStream=stream;
          this.setupAudioProcessing();

        } catch(err){
          console.error(err);
          this.updateStatus('Error accessing audio. Check permissions (or switch to MIC).');
        }
      }

      setupAudioProcessing(){
        if (this.audioContext) try{ this.audioContext.close(); }catch(e){}
        this.audioContext=new (window.AudioContext||window.webkitAudioContext)();

        this.sourceNode=this.audioContext.createMediaStreamSource(this.audioStream);
        this.analyser=this.audioContext.createAnalyser();
        this.destination=this.audioContext.createMediaStreamDestination();

        this.bassFilter=this.audioContext.createBiquadFilter();
        this.bassFilter.type='lowshelf';
        this.bassFilter.frequency.value=200;

        this.midFilter=this.audioContext.createBiquadFilter();
        this.midFilter.type='peaking';
        this.midFilter.frequency.value=1000;
        this.midFilter.Q.value=1;

        this.trebleFilter=this.audioContext.createBiquadFilter();
        this.trebleFilter.type='highshelf';
        this.trebleFilter.frequency.value=3000;

        this.reverbNode=this.audioContext.createConvolver();
        this.reverbGain=this.audioContext.createGain();
        this.reverbGain.gain.value=0;

        this.delayNode=this.audioContext.createDelay();
        this.delayNode.delayTime.value=0.3;
        this.delayGain=this.audioContext.createGain();
        this.delayGain.gain.value=0;

        this.saturationNode=this.audioContext.createWaveShaper();
        this.saturationNode.curve=this.createSaturationCurve(0);

        this.sourceNode.connect(this.bassFilter);
        this.bassFilter.connect(this.midFilter);
        this.midFilter.connect(this.trebleFilter);
        this.trebleFilter.connect(this.saturationNode);
        this.saturationNode.connect(this.analyser);

        this.saturationNode.connect(this.reverbNode);
        this.reverbNode.connect(this.reverbGain);
        this.reverbGain.connect(this.analyser);

        this.saturationNode.connect(this.delayNode);
        this.delayNode.connect(this.delayGain);
        this.delayGain.connect(this.analyser);

        this.analyser.connect(this.destination);

        this.analyser.fftSize=256;
        this.dataArray=new Uint8Array(this.analyser.frequencyBinCount);
        this.updateVUMeter();

        this.updateAudioEffects();
      }

      createSaturationCurve(amount){
        const curve=new Float32Array(65536);
        const k=amount*10;
        for (let i=0;i<65536;i++){
          const x=(i-32768)/32768;
          curve[i]=Math.tanh(x*(1+k))/Math.tanh(1+k);
        }
        return curve;
      }

      updateAudioEffects(){
        if(!this.audioContext) return;
        this.bassFilter.gain.value=this.knobValues.bass;
        this.midFilter.gain.value=this.knobValues.mid;
        this.trebleFilter.gain.value=this.knobValues.treble;

        this.reverbGain.gain.value=this.knobValues.reverb/100;
        this.delayGain.gain.value=this.knobValues.delay/100;
        this.saturationNode.curve=this.createSaturationCurve(this.knobValues.saturation/100);

        this.createReverbImpulse(this.knobValues.reverb/100);
      }

      createReverbImpulse(amount){
        const duration=2;
        const decay=2;
        const sampleRate=this.audioContext.sampleRate;
        const length=sampleRate*duration;
        const impulse=this.audioContext.createBuffer(2, length, sampleRate);
        const left=impulse.getChannelData(0);
        const right=impulse.getChannelData(1);

        for (let i=0;i<length;i++){
          left[i]=(Math.random()*2-1)*Math.pow(1-i/length, decay)*amount;
          right[i]=(Math.random()*2-1)*Math.pow(1-i/length, decay)*amount;
        }
        this.reverbNode.buffer=impulse;
      }

      updateVUMeter(){
        if(!this.analyser){
          this.vuLevel.style.width='0%';
          requestAnimationFrame(()=>this.updateVUMeter());
          return;
        }
        this.analyser.getByteFrequencyData(this.dataArray);
        let sum=0;
        for (let i=0;i<this.dataArray.length;i++) sum+=this.dataArray[i];
        const avg=sum/this.dataArray.length;
        const level=Math.min(95, Math.max(0, (avg/128)*100));
        this.vuLevel.style.width=`${level}%`;
        requestAnimationFrame(()=>this.updateVUMeter());
      }

      async startRecording(){
        if(!this.audioStream){ this.updateStatus('Error: No audio source available'); return; }
        try{
          const audioTracks=this.audioStream.getAudioTracks();
          if(audioTracks.length===0){ this.updateStatus('Error: No audio tracks available'); return; }

          let mimeType='';
          const types=['audio/webm;codecs=opus','audio/webm','audio/mp4','audio/ogg;codecs=opus'];
          for (const t of types){ if (MediaRecorder.isTypeSupported(t)){ mimeType=t; break; } }

          this.mediaRecorder=new MediaRecorder(this.destination.stream, { mimeType, audioBitsPerSecond:192000 });
          this.audioChunks=[];
          this.mediaRecorder.ondataavailable=(e)=>{ if(e.data.size>0) this.audioChunks.push(e.data); };
          this.mediaRecorder.onstop=()=> this.processRecording();
          this.mediaRecorder.start(1000);

          this.isRecording=true;
          this.recordingStart=Date.now();

          this.recordBtn.disabled=true;
          this.recordBtn.classList.add('recording');
          this.stopBtn.disabled=false;
          this.saveBtn.disabled=true;

          this.startTimer();
          this.updateStatus('<span class="recording-indicator"></span> Recording...');
        } catch(err){
          console.error(err);
          this.updateStatus('Error starting recording: '+(err?.message||'unknown'));
        }
      }

      stopRecording(){
        if(this.mediaRecorder && this.isRecording){
          this.mediaRecorder.stop();
          this.isRecording=false;

          this.recordBtn.disabled=false;
          this.recordBtn.classList.remove('recording');
          this.stopBtn.disabled=true;

          this.stopTimer();
          this.updateStatus('Processing recording...');
        }
      }

      startTimer(){
        this.stopTimer();
        this.updateTimer();
        this.timerInterval=setInterval(()=>this.updateTimer(), 1000);
      }
      stopTimer(){
        if(this.timerInterval){ clearInterval(this.timerInterval); this.timerInterval=null; }
      }
      updateTimer(){
        if(!this.recordingStart) return;
        const elapsed=Date.now()-this.recordingStart;
        const h=String(Math.floor(elapsed/3600000)).padStart(2,'0');
        const m=String(Math.floor((elapsed%3600000)/60000)).padStart(2,'0');
        const s=String(Math.floor((elapsed%60000)/1000)).padStart(2,'0');
        this.timerDisplay.textContent=`${h}:${m}:${s}`;
      }

      processRecording(){
        const mime=this.mediaRecorder?.mimeType || 'audio/webm';
        const blob=new Blob(this.audioChunks, { type:mime });
        this.recordingBlob=blob;

        this.saveBtn.disabled=false;
        const kb=Math.round(blob.size/1024);
        this.updateStatus(`Recording ready (${kb}KB) - Click SAVE to download`);
      }

      downloadRecording(){
        if(!this.recordingBlob){ this.updateStatus('No recording available'); return; }
        const ts=new Date().toISOString().replace(/[:.]/g,'-').replace('T','_').slice(0,19);
        let ext='webm';
        if(this.mediaRecorder?.mimeType?.includes('mp4')) ext='mp4';
        if(this.mediaRecorder?.mimeType?.includes('ogg')) ext='ogg';

        const filename=`crate-records-${ts}.${ext}`;
        const url=URL.createObjectURL(this.recordingBlob);

        const a=document.createElement('a');
        a.href=url;
        a.download=filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(()=>{
          URL.revokeObjectURL(url);
          this.updateStatus('Recording downloaded!');
          setTimeout(()=>{ this.updateStatus('Ready for new recording'); this.saveBtn.disabled=true; }, 2000);
        }, 100);
      }

      updateStatus(msg){
        this.statusText.innerHTML=msg;
        if (String(msg).includes('Recording')) this.statusText.classList.add('recording');
        else this.statusText.classList.remove('recording');
      }

      async installApp(){
        if(this.deferredPrompt){
          this.deferredPrompt.prompt();
          await this.deferredPrompt.userChoice;
          this.deferredPrompt=null;
          this.installBtn.classList.add('hidden');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{ window.studio=new CrateRecordsStudio(); });

    // Dynamic manifest
    const manifest={
      name:"CRATE RECORDS OUTSIDE",
      short_name:"CrateRecords",
      description:"Audio capture studio",
      start_url:"/",
      display:"standalone",
      background_color:"#0a0a0a",
      theme_color:"#00ff88",
      orientation:"portrait-primary",
      categories:["music","productivity","utilities"],
      icons:[{
        src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23000000'/><circle cx='50' cy='50' r='35' fill='%2300ff88' stroke='%23ffffff' stroke-width='3'/><path d='M50,20 L50,80 M20,50 L80,50' stroke='%23000000' stroke-width='4'/></svg>",
        sizes:"100x100",
        type:"image/svg+xml"
      },{
        src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='100' fill='%23000000'/><circle cx='256' cy='256' r='180' fill='%2300ff88' stroke='%23ffffff' stroke-width='20'/><path d='M256,150 L256,362 M150,256 L362,256' stroke='%23000000' stroke-width='30'/></svg>",
        sizes:"512x512",
        type:"image/svg+xml"
      }]
    };
    const manifestBlob=new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const manifestUrl=URL.createObjectURL(manifestBlob);
    const link=document.createElement('link');
    link.rel='manifest';
    link.href=manifestUrl;
    document.head.appendChild(link);
  </script>
</body>
</html>
